---
title: Advanced Certificate Rotation with CredHub Maestro
owner: CredHub Maestro
---

This topic describes how to rotate certificates and Certificate Authorities (CAs) in CredHub using CredHub Maestro.

This topic only covers rotating CredHub-managed certificates. To rotate Ops Manager managed certificates, see [Rotating Certificates](api-cert-rotation.html).

<p class="note warning"><strong>Warning:</strong> With Ops Manager v2.8 and PAS v2.8, you can use
the Maestro CLI to rotate your CredHub certificates. To ensure safe certificate rotation, you must
use both Ops Manager v2.9 and PAS v2.9. Pivotal recommends that you upgrade Ops Manager and PAS to
v2.9 to use safe Maestro certificate rotation.</p>

## <a id='overview'></a> Overview

CredHub Maestro is a command-line interface (CLI) that facilitates rotations of certificates in CredHub. Using CredHub Maestro, you can:

* Determine if any of your CredHub certificates are expiring soon

* Rotate CredHub certificates

* Clean up inactive certificate versions so that CredHub does not run out of disk space

For more information about setting up and using CredHub Maestro, see [Getting Started with CredHub Maestro](getting-started-with-maestro-cli.html).

<p class="note warning"><strong>Warning:</strong> Not every <%= vars.platform_name %> tile
supports certificate rotation so there is a potential for downtime. See
<a href="maestro-tile-compatibility.html">CredHub Maestro Tile Compatibility</a> for more
information about which tiles support certificate rotation.</p>

## <a id='prerequisites'></a> Prerequisites

Before you rotate CredHub-managed certificates:

* All CredHub Maestro rotation workflows ignore certificates manually set in CredHub by default. Before rotating certificates in Ops Manager v2.8, you must reset any certificates that were manually set in CredHub on Ops Manager v2.6 and earlier to prevent them from being rotated with other certificates generated by CredHub. To find and reset any manually set certificates in CredHub, follow the procedure in [Reviewing Manually Set Certificates in CredHub](manual-credhub-certificate.html). For more information, see [Reset Manually Set Certificates in CredHub Before Rotating Certificates](https://docs.pivotal.io/platform/2-8/release-notes/opsmanager-rn.html#credhub-generated-field) in _Pivotal Operations Manager v2.8 Release Notes_.

* To ensure that there is no app availability downtime during a rotation, Pivotal recommends that you scale up all instance groups and use an external blobstore.


## <a id='check-expiration'></a> Check Expiration Dates and Certificate Types

This section describes how to manually check the expiration dates of the CAs and leaf certificates managed by CredHub.

After identifying the types of certificates that expire soon, you can determine which certificate rotation procedure to follow.

To check certificate expiration dates and types:

1. Retrieve a list of certificates expiring within a given timeframe by running:

    ```
    maestro list --expires-within TIME-PERIOD
    ```
    Where `TIME-PERIOD` is the unit for which you want to check the expiry window. Valid units are `d` for days, `w` for weeks, `m` for months, and `y` for years.

1. After you identify the list of certificates that expire soon, complete the [Rotate Certificates](#rotate-certs) procedure below.


## <a id='rotate-certs'></a> Rotate Certificates

This section explains how to rotate leaf certificates and CAs stored in CredHub. There are different rotation procedures for each type of certificate that requires rotation.

You can determine which rotation procedure to follow based on the types of certificates in your foundation that must be rotated.

To rotate certificates, do one of the following procedures:

* If multiple CAs are expiring soon, see [Rotate All CAs and Leaf Certificates](#bulk-rotation).

* If the only certificates expiring are leaf certificates, see [Rotate All Leaf Certificates](#leaf-rotation).

* To only rotate a subset of CAs, see [Rotate a Single CA and Its Leaf Certificates](#single-rotation).

* To rotate the Services TLS CA, see [Rotate the Services TLS CA and Its Leaf Certificates](#services-rotation).

* To rotate CredHub Set Certificates, see [Rotate CredHub Set Certificates](#set-certificate-rotation).

<p class="note"><strong>Note:</strong> All CredHub Maestro rotation commands have a dry-run flag that can be used to preview the certificates to be modified.</p>

### <a id='bulk-rotation'></a> Rotate All CAs and Leaf Certificates

This section describes the procedure for rotating all CAs and leaf certificates.

<div class="note"><strong>Note:</strong> If any of your deployments use a Services TLS CA:
<ul>
  <li>Run all CredHub Maestro commands except <code>maestro regenerate leaf</code> with <code>--exclude /services/tls_ca</code>.</li>
  <li>Run <code>maestro regenerate leaf</code> with <code>--exclude-signed-by /services/tls_ca</code>.</li>
</ul>
The process for rotating the Services TLS CA requires additional steps to ensure that there is no downtime. To rotate a Services TLS CA, see <a href="#services-rotation">Rotate the Services TLS CA and Its Leaf Certificates</a>.</div>

To rotate all CAs and leaf certificates in CredHub:

1. Regenerate all CAs. This creates a new version of every CA. Run:

    ```
    maestro regenerate ca --all
    ```

1. Mark the latest version of each CA as transitional. This indicates that the certificate is inactive, so that all leaf certificates trust the new CA version. Run:

    ```
    maestro update-transitional latest --all
    ```

1. Redeploy all deployments.

1. Mark the signing version of each CA as transitional by running:

    ```
    maestro update-transitional signing --all
    ```

1. Regenerate all leaf certificates by running:

    ```
    maestro regenerate leaf --all
    ```

1. Redeploy all deployments.

1. Remove the transitional flag on all certificate versions. This removes the old, inactive CA versions on the next deploy. Run:

    ```
    maestro update-transitional remove --all
    ```

1. Redeploy all deployments.

### <a id='leaf-rotation'></a> Rotating All Leaf Certificates

This section describes the procedure for rotating all leaf certificates.

To rotate all leaf certificates in CredHub:

1. Regenerate all leaf certificates by running:

    ```
    maestro regenerate leaf --all
    ```

1. Redeploy all deployments.

### <a id='single-rotation'></a> Rotate a Single CA and Its Leaf Certificates

This section describes the procedure for rotating a single CA and its leaf certificates.

To rotate a single CA and its leaf certificates:

1. Regenerate the CA you want to rotate. This creates a new version of this CA. Run:

    ```
    maestro regenerate ca --name "CA-NAME"
    ```
    <p class="note"><strong>Note:</strong> The CA name you provide must be the full path to the credential.</p>

1. Mark the latest version of the single CA as transitional by running:

    ```
    maestro update-transitional latest --name "CA-NAME"
    ```

1. Redeploy all deployments that use the CA.

1. Mark the signing version of the CA as transitional by running:

    ```
    maestro update-transitional signing --name "CA-NAME"
    ```

1. Regenerate all leaf certificates signed by the CA by running:

    ```
    maestro regenerate leaf --signed-by "CA-NAME"
    ```

1. Redeploy all deployments that use the CA.

1. Remove the transitional flag from the CA. This removes the old, inactive CA version on the next deploy. Run:

    ```
    maestro update-transitional remove --name "CA-NAME"
    ```

1. Redeploy all deployments that use the CA.

### <a id='services-rotation'></a> Rotate the Services TLS CA and Its Leaf Certificates

This section describes the procedure for rotating the Services TLS CA and its leaf certificates.

<p class="note warning"><strong>Warning:</strong> Rotating the Services TLA CA and its leaf certificates is not yet supported. Do not attempt to rotate these certificates.</p>

### <a id='set-certificate-rotation'></a> Rotate Manually Set Certificates

This section describes the procedure for rotating certificates that are manually set in CredHub.

To rotate a manually set certificate:

1. Create a new CA using the same parameters you used for the original CA.

1. Use the <a href="https://github.com/cloudfoundry-incubator/credhub-cli" target="_blank">CredHub CLI</a> or <a href="https://credhub-api.cfapps.io/" target="_blank">CredHub API</a> to set the new CA at the same path as the original.

1. Mark the latest version of the single CA as transitional. This indicates that the certificate is inactive. Run:

    ```
    maestro update-transitional latest --name "CA-NAME"
    ```
    <p class="note"><strong>Note:</strong> The CA name you provide must be the full path to the credential.</p>

1. Redeploy all deployments that use the CA you are rotating.

1. Mark the signing version of the single CA as transitional by running:

    ```
    maestro update-transitional signing --name "CA-NAME"
    ```

1. Regenerate all leaf certificates that are signed by the CA you are rotating. Run:

    ```
    maestro regenerate leaf --signed-by "CA-NAME"
    ```

    <p class="note"><strong>Note:</strong> You might need to use the <code>--force</code> flag when regenerating leaf certificates if they were set by CredHub. Otherwise, you must provide a new leaf certificate at the same path.</p>

1. Redeploy all deployments that use the CA you are rotating.

1. Remove the transitional flag from the single CA. This removes the old, inactive CA version on the next deploy. Run:

    ```
    maestro update-transitional remove --name "CA-NAME"
    ```

1. Redeploy all deployments that use the CA you are rotating.

## <a id='garbage-collection'></a> Delete Inactive Certificate Versions

Over the course of many rotations, it is possible for the CredHub database to fill up. In order to prevent this, you can periodically use CredHub Maestro's garbage collect functionality to delete old, unused certificate versions.

You can run garbage collect on leaf certificates and CAs. Generally, deleting leaf certificates is enough to free up space in the database.

To see if you need to run garbage collect, do one of the following:

* Manually check the BOSH Director's VM vitals through your IaaS provider.

* SSH into the BOSH Director and run `df -h /var/vcap/store`.

<p class='note warning'><strong>Warning:</strong> To enhance the safety of the garbage collect command, CredHub Maestro only deletes versions of a certificate older than the currently active version. To delete all inactive versions of CAs or leaf certificates, add the <code>--force</code> flag to the garbage collect command. Pivotal does not recommend using the <code>--force</code> flag during a rotation.</p>

### <a id='leaf-cert-cleanup'></a> Delete All Leaf Certificates

To delete all leaf certificates:

1. Determine which certificate versions you want to delete by running:

    ```
    maestro garbage-collect leaf --all --dry-run
    ```

1. Delete the certificate versions by running:

    ```
    maestro garbage-collect leaf --all
    ```

### <a id='ca-cleanup'></a> Delete All CAs

To delete all CAs:

1. Determine which CA versions you want to delete by running:

    ```
    maestro garbage-collect ca --all --dry-run
    ```

1. Delete the CA versions by running:

    ```
    maestro garbage-collect ca --all
    ```

### <a id='single-leaf-cert-cleanup'></a> Delete a Single Leaf Certificate

To delete a single leaf certificate:

1. Determine which certificate versions you want to delete by running:

    ```
    maestro garbage-collect leaf --name "LEAF-CERTIFICATE-NAME" --dry-run
    ```

1. Delete the certificate versions by running:

    ```
    maestro garbage-collect leaf --name "LEAF-CERTIFICATE-NAME"
    ```

### <a id='single-ca-cleanup'></a> Delete a Single CA

To delete a single CA:

1. Determine which certificate versions you want to delete by running:

    ```
    maestro garbage-collect leaf --name "LEAF-CERTIFICATE-NAME" --dry-run
    ```

1. Delete the certificate versions by running:

    ```
    maestro garbage-collect leaf --name "LEAF-CERTIFICATE-NAME"
    ```
